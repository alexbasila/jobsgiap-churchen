<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GIAP — Draft Studio (lite)</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{--w:920px}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1224;color:#e2e8f0}
    header{background:#0f172a;border-bottom:1px solid #1f2937}
    .bar{max-width:var(--w);margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:10px}
    .brand{font-weight:800}
    main{max-width:var(--w);margin:0 auto;padding:16px}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px;box-shadow:0 6px 22px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    textarea{width:100%;min-height:130px;padding:12px;border:1px solid #334155;border-radius:12px;background:#0b1224;color:#e2e8f0;font:inherit}
    button{padding:10px 14px;border-radius:12px;border:1px solid #334155;background:#18223b;color:#e2e8f0;font-weight:700;cursor:pointer}
    button.primary{background:#2563eb;border-color:#2563eb}
    button.success{background:#22c55e;border-color:#22c55e;color:#0b1224}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #1f2937;background:#0b1224;color:#cbd5e1;font-size:12px}
    ul{list-style:none;margin:6px 0 0;padding:0}
    li{padding:6px;border-bottom:1px solid #1f2937}
    pre{white-space:pre-wrap;background:#0b1224;border:1px solid #1f2937;border-radius:12px;padding:10px;max-height:260px;overflow:auto}
    .muted{color:#94a3b8}
    .ok{border:1px solid #22c55e;background:#0f2b1a;color:#c6f6d5;border-radius:10px;padding:10px}
    .warn{border:1px solid #f59e0b;background:#3b2f0b;color:#ffecc7;border-radius:10px;padding:10px}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">GIAP — Draft Studio</div>
    <span class="muted" id="hdr-id">—</span>
    <div style="margin-left:auto" class="row">
      <button id="btn-back">← Zurück</button>
      <button id="btn-refresh">Neu laden</button>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Draft</h2>
      <button id="btn-finalize" class="success">Finalisieren & veröffentlichen</button>
    </div>
    <div class="muted" style="margin:6px 0">IdeaID: <span id="idea-id" class="pill">—</span></div>
    <div class="muted" style="margin-top:8px">Abstract</div>
    <pre id="abstract">—</pre>

    <div class="muted" style="margin-top:8px">Feedback</div>
    <ul id="reasons"></ul>

    <div class="row" style="margin-top:10px">
      <textarea id="user-text" placeholder="Nächster Gedanke oder Bitte an GPT…"></textarea>
      <div class="row">
        <button id="btn-iterate" class="primary">Mit GPT iterieren</button>
      </div>
    </div>
    <p class="muted" id="notice"></p>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">Log</h3>
    <pre id="log">—</pre>
  </section>
</main>

<script>
(function(){
  'use strict';

  // ▼▼ EINSTELLEN: URL deines Drafts-Workers ▼▼
  const DRAFTS_API = "https://giap-drafts.csac6316.workers.dev";

  const $ = s => document.querySelector(s);
  const qs = new URLSearchParams(location.search);
  const hash = (qs.get("hash") || "").trim();

  const ui = {
    ideaId: $("#idea-id"),
    abstract: $("#abstract"),
    reasons: $("#reasons"),
    log: $("#log"),
    notice: $("#notice"),
    idHdr: $("#hdr-id"),
    btnIter: $("#btn-iterate"),
    btnFin: $("#btn-finalize"),
    userText: $("#user-text"),
  };

  function log(tag, obj){
    let txt = "";
    try{ txt = JSON.stringify(obj,null,2) } catch { txt = String(obj) }
    ui.log.textContent = `${tag?tag+" ✓ ":""}${txt}\n\n` + ui.log.textContent;
  }
  function setNotice(msg, ok=false){
    ui.notice.className = ok ? "ok" : (msg ? "warn" : "");
    ui.notice.textContent = msg || "";
  }
  function applyDraft(d){
    ui.idHdr.textContent = d.id || "—";
    ui.ideaId.textContent = d.id || "—";
    ui.abstract.textContent = d.abstract || "—";
    ui.reasons.innerHTML = "";
    (d.reasons||[]).forEach(r => {
      const li = document.createElement("li");
      li.textContent = r;
      ui.reasons.appendChild(li);
    });
  }

  async function api(path, opts){
    const r = await fetch(`${DRAFTS_API}${path}`, opts||{});
    let data = {};
    try{ data = await r.json() }catch{}
    return { ok:r.ok, status:r.status, data };
  }

  async function load(){
    if (!hash){ setNotice("Kein Draft-Hash in der URL (drafts.html?hash=...)"); return; }
    const { ok, data } = await api(`/drafts/${encodeURIComponent(hash)}`);
    log("load", data);
    if (ok && data?.draft){ applyDraft(data.draft); setNotice("Draft geladen.", true); }
    else setNotice(data?.error || "load_error");
  }

  $("#btn-refresh").onclick = load;
  $("#btn-back").onclick = ()=> history.length ? history.back() : (location.href="/");

  $("#btn-iterate").onclick = async ()=>{
    const t = ui.userText.value.trim();
    if (!t){ setNotice("Bitte Text eingeben."); return; }
    ui.btnIter.disabled = true;
    const { ok, data, status } = await api(`/drafts/iterate`, {
      method:"POST", headers:{ "content-type":"application/json" },
      body: JSON.stringify({ hash, user_text: t })
    });
    log("iterate", {status, data});
    ui.btnIter.disabled = false;
    if (ok && data?.draft){ applyDraft(data.draft); ui.userText.value=""; setNotice("Iteration ok.", true); }
    else setNotice(data?.error || "iterate_error");
  };

  $("#btn-finalize").onclick = async ()=>{
    ui.btnFin.disabled = true;
    const { ok, data, status } = await api(`/drafts/finalize`, {
      method:"POST", headers:{ "content-type":"application/json" },
      body: JSON.stringify({ hash })
    });
    log("finalize", {status, data});
    ui.btnFin.disabled = false;
    if (ok && data?.publish?.ok){
      setNotice("Veröffentlicht! Deine Idee hat jetzt eine Adresse.", true);
      // Optional: öffentliche JSON in neuem Tab
      const id = data.draft?.id;
      if (id) {
        const blob = new Blob([JSON.stringify({ id, abstract: data.draft.abstract }, null, 2)], {type:"application/json"});
        window.open(URL.createObjectURL(blob), "_blank", "noopener");
      }
    } else {
      setNotice(data?.error || "Publish fehlgeschlagen.");
    }
  };

  // init
  load();
})();
</script>
</body>
</html>
